<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8" />
    <title>Foreningskalender – Fakultet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg: #f5f5f7;
            --card-bg: #ffffff;
            --accent: #2563eb;
            --accent-soft: #dbeafe;
            --text: #111827;
            --muted: #6b7280;
            --radius: 12px;
            --shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
            --danger: #dc2626;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        .page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            padding: 8px 0 16px;
        }

        h1 {
            margin: 0 0 2px;
            font-size: 1.4rem;
        }

        .sub {
            margin: 0;
            font-size: 0.85rem;
            color: var(--muted);
        }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-small {
            padding: 8px 12px;
            border-radius: 999px;
            border: none;
            background: var(--accent);
            color: #fff;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #111827;
        }

        main {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 12px 16px;
        }

        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .filter-btn {
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            font-size: 0.8rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .filter-btn.active {
            background: var(--accent);
            color: #ffffff;
            border-color: var(--accent);
        }

        .filter-btn .heart {
            font-size: 0.9rem;
        }

        .org-chips {
            display: flex;
            flex-wrap: nowrap;
            gap: 6px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .org-chip {
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            font-size: 0.75rem;
            cursor: pointer;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .org-chip-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #9ca3af;
        }

        .org-chip.active {
            border-color: var(--accent);
            background: var(--accent-soft);
        }

        .calendar-layout {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .calendar-main {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .month-nav-btn {
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .month-label {
            font-size: 0.95rem;
            font-weight: 600;
        }

        /* Måned-grid – skjules på mobil, vises på desktop */
        .month-grid-wrapper {
            display: none;
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 4px;
            font-size: 0.8rem;
        }

        .month-grid-header {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--muted);
            text-align: center;
            padding-bottom: 2px;
        }

        .day-cell {
            background: #f9fafb;
            border-radius: 8px;
            min-height: 92px;
            padding: 4px 4px 4px 4px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .day-cell.outside {
            opacity: 0.4;
        }

        .day-number {
            font-size: 0.75rem;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 2px;
        }

        .event-pill {
            border-radius: 6px;
            padding: 2px 4px;
            font-size: 0.7rem;
            color: #0f172a;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .event-pill-title {
            font-weight: 500;
        }

        .event-pill-org {
            opacity: 0.9;
            font-size: 0.65rem;
        }

        /* Listevisning (mobil og evt. under grid) */
        .event-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 4px;
        }

        .event-list-item {
            background: #f9fafb;
            border-radius: 10px;
            padding: 8px 10px;
            border: 1px solid #e5e7eb;
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            gap: 2px;
            cursor: pointer;
        }

        .event-list-title {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .event-list-meta {
            font-size: 0.75rem;
            color: var(--muted);
        }

        .event-list-org-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 6px;
            border-radius: 999px;
            background: #eff6ff;
            font-size: 0.7rem;
        }

        .event-list-org-dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: #2563eb;
        }

        .status {
            margin-top: 4px;
            font-size: 0.8rem;
        }

        .status--error { color: var(--danger); }
        .status--success { color: #15803d; }

        /* Modal (sentrert) */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.25);
            max-width: 480px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 16px 18px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .modal-title {
            font-size: 1.05rem;
            font-weight: 600;
            margin: 0;
        }

        .modal-close {
            border: none;
            background: transparent;
            font-size: 1.1rem;
            cursor: pointer;
        }

        .modal-body p {
            font-size: 0.85rem;
            margin: 4px 0;
        }

        .modal-body .label {
            font-weight: 600;
        }

        .modal-footer {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .chip-small {
            padding: 2px 6px;
            border-radius: 999px;
            font-size: 0.7rem;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
        }

        .login-info {
            font-size: 0.75rem;
            color: var(--muted);
        }

        @media (min-width: 900px) {
            .page {
                padding: 24px;
            }
            .calendar-layout {
                flex-direction: row;
                align-items: flex-start;
            }
            .calendar-main {
                flex: 1.4;
            }
            .calendar-sidebar {
                flex: 0.8;
            }
            .month-grid-wrapper {
                display: block;
            }
        }
        @media (max-width: 899px) {
            .calendar-header {
                display: none;
            }
        }
    </style>
</head>
<body>
<div class="page">
    <header>
        <div>
            <h1>Foreningskalender</h1>
            <p class="sub">Se kommende events fra foreningene på fakultetet.</p>
        </div>
        <div class="header-actions">
            <button class="btn-small btn-secondary" id="myPageBtn">Min side</button>
            <button class="btn-small btn-secondary" id="orgPageBtn">Foreningsside</button>
            <button class="btn-small btn-secondary" id="loginBtn">Logg inn</button>
            <button class="btn-small" id="logoutBtn" style="display:none;">Logg ut</button>
        </div>
    </header>

    <main>
        <!-- Filterkort -->
        <section class="card">
            <div class="filters-row">
                <button class="filter-btn active" data-filter="all" id="filterAllBtn">
                    Alle
                </button>
                <button class="filter-btn" data-filter="favorites" id="filterFavBtn">
                    <span class="heart">♥</span> Favoritter
                </button>
                <div class="org-chips" id="orgChips"></div>
            </div>
            <div id="filterStatus" class="status"></div>
        </section>

        <div class="calendar-layout">
            <div class="calendar-main">
                <!-- Måned-header -->
                <section class="card">
                    <div class="calendar-header">
                        <div>
                            <button class="month-nav-btn" id="prevMonthBtn">&laquo; Forrige</button>
                            <button class="month-nav-btn" id="nextMonthBtn">Neste &raquo;</button>
                        </div>
                        <div class="month-label" id="monthLabel"></div>
                    </div>

                    <!-- Desktop: måned-grid -->
                    <div class="month-grid-wrapper">
                        <div class="month-grid" id="monthGrid"></div>
                    </div>

                    <!-- Mobil + tillegg: listevisning -->
                    <div class="event-list" id="eventList"></div>
                    <div id="eventsStatus" class="status"></div>
                </section>
            </div>
        </div>
    </main>
</div>

<!-- Modal for eventdetaljer (brukes fra både liste og måned-grid) -->
<div class="modal-overlay" id="eventModal">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle"></h2>
            <button class="modal-close" id="modalCloseBtn">&times;</button>
        </div>
        <div class="modal-body">
            <p id="modalOrg"></p>
            <p id="modalWhen"></p>
            <p id="modalLocation"></p>
            <p id="modalDescription"></p>
            <p id="modalPrice"></p>
            <p id="modalRegInfo"></p>
        </div>
        <div class="modal-footer">
            <span id="modalSeatInfo" class="chip-small"></span>
            <span id="modalPaymentInfo" class="chip-small"></span>
        </div>
    </div>
</div>

<script type="module">
    import { db, auth } from "./firebase-init.js";
    import {
        onAuthStateChanged,
        signOut,
        signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
        collection,
        getDocs,
        doc,
        getDoc,
        query,
        where,
        orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // DOM
    const myPageBtn = document.getElementById("myPageBtn");
    const orgPageBtn = document.getElementById("orgPageBtn");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    const filterAllBtn = document.getElementById("filterAllBtn");
    const filterFavBtn = document.getElementById("filterFavBtn");
    const orgChipsContainer = document.getElementById("orgChips");
    const filterStatus = document.getElementById("filterStatus");

    const monthLabelEl = document.getElementById("monthLabel");
    const prevMonthBtn = document.getElementById("prevMonthBtn");
    const nextMonthBtn = document.getElementById("nextMonthBtn");
    const monthGridEl = document.getElementById("monthGrid");

    const eventListEl = document.getElementById("eventList");
    const eventsStatus = document.getElementById("eventsStatus");

    const eventModal = document.getElementById("eventModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalOrg = document.getElementById("modalOrg");
    const modalWhen = document.getElementById("modalWhen");
    const modalLocation = document.getElementById("modalLocation");
    const modalDescription = document.getElementById("modalDescription");
    const modalPrice = document.getElementById("modalPrice");
    const modalRegInfo = document.getElementById("modalRegInfo");
    const modalSeatInfo = document.getElementById("modalSeatInfo");
    const modalPaymentInfo = document.getElementById("modalPaymentInfo");
    const modalCloseBtn = document.getElementById("modalCloseBtn");

    // State
    let currentUser = null;
    let currentUserProfile = null;
    let organizations = [];
    let orgMap = new Map(); // orgId -> data
    let favoriteOrgIds = new Set();

    let allEventsForMonth = [];    // alle events for aktiv måned (desktop)
    let allUpcomingEvents = [];    // alle fremtidige events (mobil)
    let filteredEvents = [];       // events etter filter

    let activeFilterType = "all";  // "all" | "favorites" | "org"
    let activeOrgFilterId = null;

    // Måned-state (for desktop)
    let currentMonthDate = new Date();
    currentMonthDate.setDate(1);

    // Responsivt: mobil vs desktop
    let isMobile = window.matchMedia("(max-width: 899px)").matches;

    const mq = window.matchMedia("(max-width: 899px)");
    mq.addEventListener("change", async (e) => {
        isMobile = e.matches;

        if (isMobile) {
            await loadAllUpcomingEvents();
        } else {
            await loadEventsForCurrentMonth();
        }
        applyFilter(activeFilterType, activeOrgFilterId);
    });

    function setStatus(el, msg, type = null) {
        el.textContent = msg || "";
        el.classList.remove("status--success", "status--error");
        if (!msg) return;
        if (type === "success") el.classList.add("status--success");
        if (type === "error") el.classList.add("status--error");
    }

    // -------- Auth --------
    onAuthStateChanged(auth, async (user) => {
        currentUser = user;

        if (!user) {
            loginBtn.style.display = "inline-block";
            logoutBtn.style.display = "none";
            favoriteOrgIds = new Set();
            currentUserProfile = null;
            await initData();
            return;
        }

        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";

        const userRef = doc(db, "users", user.uid);
        const snap = await getDoc(userRef);
        if (snap.exists()) {
            currentUserProfile = snap.data();
            favoriteOrgIds = new Set(currentUserProfile.favoriteOrganizations || []);
        } else {
            currentUserProfile = null;
            favoriteOrgIds = new Set();
        }

        await initData();
    });

    async function initData() {
        await loadOrganizations();
        buildOrgChips();

        if (isMobile) {
            await loadAllUpcomingEvents();
        } else {
            await loadEventsForCurrentMonth();
        }

        applyFilter("all", null);
    }

    // -------- Org-data --------
    async function loadOrganizations() {
        const snap = await getDocs(collection(db, "organizations"));
        organizations = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        orgMap = new Map(organizations.map(o => [o.id, o]));
    }

    function buildOrgChips() {
        orgChipsContainer.innerHTML = "";
        const sorted = [...organizations].sort((a, b) =>
            (a.shortCode || a.name || "").localeCompare(b.shortCode || b.name || "", "no")
        );

        sorted.forEach(org => {
            const chip = document.createElement("button");
            chip.type = "button";
            chip.className = "org-chip";
            chip.dataset.orgId = org.id;

            const dot = document.createElement("span");
            dot.className = "org-chip-dot";
            dot.style.backgroundColor = org.color || "#9ca3af";

            const label = document.createElement("span");
            label.textContent = org.shortCode || org.name || org.id;

            chip.appendChild(dot);
            chip.appendChild(label);

            chip.addEventListener("click", () => {
                if (activeFilterType === "org" && activeOrgFilterId === org.id) {
                    // slå av org-filter
                    applyFilter("all", null);
                } else {
                    applyFilter("org", org.id);
                }
            });

            orgChipsContainer.appendChild(chip);
        });

        updateFilterButtonsUI();
    }

    // -------- Måned-beregninger --------
    function getMonthBounds(d) {
        const year = d.getFullYear();
        const month = d.getMonth();
        const first = new Date(year, month, 1);
        const nextMonthFirst = new Date(year, month + 1, 1);
        return { first, nextMonthFirst };
    }

    function formatMonthLabel(d) {
        const months = [
            "januar", "februar", "mars", "april", "mai", "juni",
            "juli", "august", "september", "oktober", "november", "desember"
        ];
        return `${months[d.getMonth()]} ${d.getFullYear()}`;
    }

    async function loadEventsForCurrentMonth() {
        setStatus(eventsStatus, "Laster events ...");
        const { first, nextMonthFirst } = getMonthBounds(currentMonthDate);

        // Firestore-query på startDateTime for aktuell måned
        const eventsRef = collection(db, "events");
        const qEvents = query(
            eventsRef,
            where("startDateTime", ">=", first),
            where("startDateTime", "<", nextMonthFirst),
            orderBy("startDateTime", "asc")
        );

        const snap = await getDocs(qEvents);
        allEventsForMonth = snap.docs.map(d => {
            const data = d.data();
            return {
                id: d.id,
                ...data,
                start: data.startDateTime?.toDate?.() ?? null,
                end: data.endDateTime?.toDate?.() ?? null
            };
        });

        setStatus(eventsStatus, "");
        monthLabelEl.textContent = formatMonthLabel(currentMonthDate);
    }

    async function loadAllUpcomingEvents() {
        setStatus(eventsStatus, "Laster kommende events ...");

        const now = new Date();
        const eventsRef = collection(db, "events");
        const qEvents = query(
            eventsRef,
            where("startDateTime", ">=", now),
            orderBy("startDateTime", "asc")
        );

        const snap = await getDocs(qEvents);
        allUpcomingEvents = snap.docs.map(d => {
            const data = d.data();
            return {
                id: d.id,
                ...data,
                start: data.startDateTime?.toDate?.() ?? null,
                end: data.endDateTime?.toDate?.() ?? null
            };
        });

        setStatus(eventsStatus, "");
    }

    // -------- Filtrering --------
    function applyFilter(type, orgId) {
        activeFilterType = type;
        activeOrgFilterId = orgId || null;

        const baseEvents = isMobile ? allUpcomingEvents : allEventsForMonth;

        if (type === "all") {
            filteredEvents = [...baseEvents];
            setStatus(filterStatus, "");
        } else if (type === "favorites") {
            if (!favoriteOrgIds.size) {
                filteredEvents = [];
                setStatus(filterStatus, "Ingen favorittforeninger valgt enda.", "error");
            } else {
                filteredEvents = baseEvents.filter(evt =>
                    favoriteOrgIds.has(evt.organizationId)
                );
                setStatus(filterStatus, "");
            }
        } else if (type === "org" && orgId) {
            filteredEvents = baseEvents.filter(evt => evt.organizationId === orgId);
            const org = orgMap.get(orgId);
            setStatus(
                filterStatus,
                `Viser kun events fra ${org?.shortCode || org?.name || "forening"}.`
            );
        } else {
            filteredEvents = [...baseEvents];
            setStatus(filterStatus, "");
        }

        updateFilterButtonsUI();
        renderMonthGrid();
        renderEventList();
    }

    function updateFilterButtonsUI() {
        // hovedfilterknapper
        filterAllBtn.classList.toggle("active", activeFilterType === "all");
        filterFavBtn.classList.toggle("active", activeFilterType === "favorites");

        // org-chips
        orgChipsContainer.querySelectorAll(".org-chip").forEach(chip => {
            const id = chip.dataset.orgId;
            chip.classList.toggle("active", activeFilterType === "org" && activeOrgFilterId === id);
        });
    }

    // -------- Rendering: månedsgrid --------
    function renderMonthGrid() {
        monthGridEl.innerHTML = "";

        // Uke-dager header
        const weekdays = ["Ma", "Ti", "On", "To", "Fr", "Lø", "Sø"];
        weekdays.forEach(d => {
            const h = document.createElement("div");
            h.className = "month-grid-header";
            h.textContent = d;
            monthGridEl.appendChild(h);
        });

        const year = currentMonthDate.getFullYear();
        const month = currentMonthDate.getMonth();
        const firstDayOfMonth = new Date(year, month, 1);
        const firstWeekday = (firstDayOfMonth.getDay() || 7); // 1=Ma,...7=Sø
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        const prevMonthDays = firstWeekday - 1; // antall ruter før 1.

        const totalCells = Math.ceil((prevMonthDays + daysInMonth) / 7) * 7;

        for (let cellIndex = 0; cellIndex < totalCells; cellIndex++) {
            const cell = document.createElement("div");
            cell.className = "day-cell";

            const dayOffset = cellIndex - prevMonthDays + 1;
            const cellDate = new Date(year, month, dayOffset);

            const isCurrentMonth = cellDate.getMonth() === month;
            if (!isCurrentMonth) {
                cell.classList.add("outside");
            }

            const dayNumberEl = document.createElement("div");
            dayNumberEl.className = "day-number";
            dayNumberEl.textContent = cellDate.getDate();
            cell.appendChild(dayNumberEl);

            const eventsForDay = filteredEvents.filter(evt => {
                if (!evt.start) return false;
                return evt.start.getFullYear() === cellDate.getFullYear() &&
                    evt.start.getMonth() === cellDate.getMonth() &&
                    evt.start.getDate() === cellDate.getDate();
            });

            eventsForDay.slice(0, 3).forEach(evt => {
                const org = orgMap.get(evt.organizationId);
                const pill = document.createElement("div");
                pill.className = "event-pill";
                pill.style.background = (org?.color || "#e5e7eb");

                const title = document.createElement("span");
                title.className = "event-pill-title";
                title.textContent = evt.title || "(uten tittel)";

                const orgSpan = document.createElement("span");
                orgSpan.className = "event-pill-org";
                orgSpan.textContent = org?.shortCode || org?.name || "";

                pill.appendChild(title);
                if (orgSpan.textContent) {
                    pill.appendChild(document.createTextNode(" · "));
                    pill.appendChild(orgSpan);
                }

                pill.addEventListener("click", () => openEventModal(evt));

                cell.appendChild(pill);
            });

            if (eventsForDay.length > 3) {
                const more = document.createElement("div");
                more.style.fontSize = "0.7rem";
                more.style.color = "#6b7280";
                more.textContent = `+${eventsForDay.length - 3} til`;
                cell.appendChild(more);
            }

            monthGridEl.appendChild(cell);
        }
    }

    // -------- Rendering: listevisning --------
    function renderEventList() {
        eventListEl.innerHTML = "";

        if (!filteredEvents.length) {
            eventListEl.innerHTML =
                '<div class="event-list-item">Ingen events i denne måneden for valgt filter.</div>';
            return;
        }

        filteredEvents.forEach(evt => {
            const item = document.createElement("div");
            item.className = "event-list-item";

            item.addEventListener("click", () => openEventModal(evt));

            const title = document.createElement("div");
            title.className = "event-list-title";
            title.textContent = evt.title || "(uten tittel)";

            const meta = document.createElement("div");
            meta.className = "event-list-meta";
            meta.textContent = formatEventDateTime(evt);

            const orgTag = document.createElement("span");
            orgTag.className = "event-list-org-tag";
            const org = orgMap.get(evt.organizationId);
            const dot = document.createElement("span");
            dot.className = "event-list-org-dot";
            dot.style.backgroundColor = org?.color || "#2563eb";

            const label = document.createElement("span");
            label.textContent = org?.shortCode || org?.name || evt.organizationId || "Forening";

            orgTag.appendChild(dot);
            orgTag.appendChild(label);

            item.appendChild(title);
            item.appendChild(meta);
            item.appendChild(orgTag);

            eventListEl.appendChild(item);
        });
    }

    function formatEventDateTime(evt) {
        if (!evt.start || !evt.end) return "Tid ikke satt";

        const d = evt.start;
        const pad = (n) => String(n).padStart(2, "0");
        const day = pad(d.getDate());
        const month = pad(d.getMonth() + 1);
        const year = d.getFullYear();

        const sH = pad(d.getHours());
        const sM = pad(d.getMinutes());
        const eH = pad(evt.end.getHours());
        const eM = pad(evt.end.getMinutes());

        return `${day}.${month}.${year} kl. ${sH}:${sM}–${eH}:${eM}`;
    }

    // -------- Modal (samme for liste + grid) --------
    function openEventModal(evt) {
        const org = orgMap.get(evt.organizationId);

        modalTitle.textContent = evt.title || "(uten tittel)";
        modalOrg.innerHTML = `<span class="label">Forening:</span> ${
            org?.shortCode ? `${org.shortCode} – ${org.name}` : (org?.name || "Ukjent forening")
        }`;

        modalWhen.innerHTML = `<span class="label">Når:</span> ${formatEventDateTime(evt)}`;

        if (evt.location) {
            modalLocation.innerHTML = `<span class="label">Sted:</span> ${evt.location}`;
        } else {
            modalLocation.textContent = "";
        }

        if (evt.description) {
            modalDescription.innerHTML = `<span class="label">Beskrivelse:</span> ${evt.description}`;
        } else {
            modalDescription.textContent = "";
        }

        const priceMember = evt.priceMember ?? 0;
        const priceNonMember = evt.priceNonMember ?? 0;
        if (priceMember > 0 || priceNonMember > 0) {
            modalPrice.innerHTML = `<span class="label">Pris:</span> Medlem ${priceMember} kr, ikke-medlem ${priceNonMember} kr.`;
            modalPaymentInfo.textContent = "Betaling via Vipps/kort (kommer snart)";
        } else {
            modalPrice.innerHTML = `<span class="label">Pris:</span> Gratis`;
            modalPaymentInfo.textContent = "Ingen betaling";
        }

        if (evt.maxParticipants && evt.maxParticipants > 0) {
            modalSeatInfo.textContent = `Maks ${evt.maxParticipants} plasser`;
        } else {
            modalSeatInfo.textContent = `Ubegrenset antall plasser`;
        }

        if (evt.registrationOpensAt && evt.registrationOpensAt.toDate) {
            const d = evt.registrationOpensAt.toDate();
            const pad = (n) => String(n).padStart(2, "0");
            const dateStr = `${pad(d.getDate())}.${pad(d.getMonth() + 1)}.${d.getFullYear()}`;
            const timeStr = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
            modalRegInfo.innerHTML = `<span class="label">Påmelding åpner:</span> ${dateStr} kl. ${timeStr}`;
        } else {
            modalRegInfo.innerHTML = `<span class="label">Påmelding:</span> Åpen`;
        }

        eventModal.classList.add("active");
    }

    function closeEventModal() {
        eventModal.classList.remove("active");
    }

    modalCloseBtn.addEventListener("click", closeEventModal);
    eventModal.addEventListener("click", (e) => {
        if (e.target === eventModal) closeEventModal();
    });

    // -------- Navigasjon måned --------
    prevMonthBtn.addEventListener("click", async () => {
        if (isMobile) return; // ingen månedstoggling på mobil

        currentMonthDate.setMonth(currentMonthDate.getMonth() - 1);
        currentMonthDate.setDate(1);
        await loadEventsForCurrentMonth();
        applyFilter(activeFilterType, activeOrgFilterId);
    });

    nextMonthBtn.addEventListener("click", async () => {
        if (isMobile) return; // ingen månedstoggling på mobil

        currentMonthDate.setMonth(currentMonthDate.getMonth() + 1);
        currentMonthDate.setDate(1);
        await loadEventsForCurrentMonth();
        applyFilter(activeFilterType, activeOrgFilterId);
    });

    // -------- Filter-knapp events --------
    filterAllBtn.addEventListener("click", () => {
        applyFilter("all", null);
    });

    filterFavBtn.addEventListener("click", () => {
        applyFilter("favorites", null);
    });

    // -------- Header-knapper --------
    myPageBtn.addEventListener("click", () => {
        window.location.href = "profile.html"; // tilpass filnavn
    });

    orgPageBtn.addEventListener("click", () => {
        window.location.href = "organization-settings.html";
    });

    loginBtn.addEventListener("click", () => {
        // midlertidig – bytt til din egen login-side
        window.location.href = "login.html";
    });

    logoutBtn.addEventListener("click", async () => {
        try {
            await signOut(auth);
            window.location.reload();
        } catch (err) {
            console.error(err);
            alert("Kunne ikke logge ut.");
        }
    });
</script>
</body>
</html>